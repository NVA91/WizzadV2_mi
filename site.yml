---
# ------------------------------------------------------------------------------
# STEP 1: CONFIGURATION WIZARD
# ------------------------------------------------------------------------------
- name: "ğŸ§™ WizzadV2: Configuration"
  hosts: controllers
  gather_facts: false
  vars_prompt:
    - name: "wiz_target"
      prompt: "ğŸ¯ Ziel-Host (z.B. proxmox_servers)"
      default: "proxmox_servers"
      private: no

    - name: "wiz_core_infra"
      prompt: "ğŸ§± Install Core Infra (Traefik + Authentik + Logs)? (ja/nein)"
      default: "ja"
      private: no

    - name: "wiz_apps"
      prompt: "ğŸ“¦ Install Applications (Paperless, Nextcloud, Jellyfin)? (ja/nein)"
      default: "ja"
      private: no

    - name: "wiz_backup_test"
      prompt: "ğŸ§ª Run Backup & Restore Validation? (ja/nein)"
      default: "nein"
      private: no

  tasks:
    - name: "ğŸš€ Konfiguration Ã¼bergeben"
      add_host:
        name: "WIZARD_CONFIG"
        target: "{{ wiz_target }}"
        do_infra: "{{ wiz_core_infra | lower == 'ja' }}"
        do_apps: "{{ wiz_apps | lower == 'ja' }}"
        do_test: "{{ wiz_backup_test | lower == 'ja' }}"

# ------------------------------------------------------------------------------
# STEP 2: EXECUTION
# ------------------------------------------------------------------------------
- name: "âš™ï¸ Deployment"
  hosts: "{{ hostvars['WIZARD_CONFIG']['target'] | default('proxmox_servers') }}"
  gather_facts: true
  become: true

  tasks:
    - name: "ğŸ‘‹ Init"
      debug:
        msg: "Starte Deployment auf {{ inventory_hostname }}..."

    # 1. System Basis
    - include_role: { name: system_setup }
    - include_role: { name: user_management }

    # 2. Main Installation Logic
    - include_role: { name: installation_classes }

# ------------------------------------------------------------------------------
# STEP 3: REPORT
# ------------------------------------------------------------------------------
- name: "ğŸ“Š Abschluss"
  hosts: controllers
  gather_facts: false
  tasks:
    - debug: msg="âœ… Deployment Finished."
