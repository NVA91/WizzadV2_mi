---
- name: "Setup Wizard auf dem Controller ausfÃ¼hren"
  hosts: controllers
  gather_facts: false

  vars_prompt:
    - name: "wizard_selected_hosts"
      prompt: "âœ… Welche Inventoryâ€‘Gruppe oder welche Hosts sollen durchsucht werden? (z.â€¯B. all, proxyv3)"
      private: no
      default: "proxyv3"

    - name: "wizard_perform_backup"
      prompt: "ğŸ’¾ Soll ein Backup der gefundenen Dateien auf dem Controller gespeichert werden? (ja/nein)"
      private: no
      default: "ja"

    - name: "wizard_search_patterns"
      prompt: "ğŸ” Welche Dateimuster sollen durchsucht werden? (Komma-getrennt, z.â€¯B. *.conf,*.cfg,*.ini)"
      private: no
      default: "*.conf,*.cfg,*.ini"

    - name: "wizard_extra_paths"
      prompt: "ğŸ“ ZusÃ¤tzliche Verzeichnisse durchsuchen? (komma-getrennt, leer = keine)"
      private: no
      default: ""

    - name: "wizard_run_validation"
      prompt: "âœ… Soll nach dem Setup eine vollstÃ¤ndige Validierung stattfinden? (ja/nein)"
      private: no
      default: "ja"

  tasks:
    - name: "ğŸ“‹ Auswahl anzeigen"
      debug:
        msg:
          - "Hosts: {{ wizard_selected_hosts }}"
          - "Backup: {{ wizard_perform_backup }}"
          - "Muster: {{ wizard_search_patterns }}"
          - "ZusÃ¤tzliche Pfade: {{ wizard_extra_paths }}"
          - "Validierung: {{ wizard_run_validation }}"

    - name: "âš™ï¸ Variablen setzen"
      set_fact:
        selected_hosts: "{{ wizard_selected_hosts }}"
        perform_backup: "{{ wizard_perform_backup | lower == 'ja' }}"
        search_patterns: "{{ wizard_search_patterns.split(',') | map('trim') | list }}"
        extra_paths: >-
          {% if wizard_extra_paths | trim | length > 0 %}
            {{ wizard_extra_paths.split(',') | map('trim') | list }}
          {% else %}
            []
          {% endif %}
        run_validation: "{{ wizard_run_validation | lower == 'ja' }}"

    - name: "ğŸ” Validierung der Dateimuster"
      assert:
        that:
          - search_patterns | select('match', '^\\*\\.[a-zA-Z0-9]+$') | list | length == search_patterns | length
        fail_msg: "âŒ UngÃ¼ltiges Muster: {{ wizard_search_patterns }}"
        success_msg: "âœ”ï¸ Muster sind gÃ¼ltig"
      when: run_validation

    - name: "ğŸ¯ Host-Gruppe validieren"
      assert:
        that:
          - groups[selected_hosts] is defined or selected_hosts in groups['all']
        fail_msg: "âŒ Gruppe/Host '{{ selected_hosts }}' nicht gefunden!"
        success_msg: "âœ”ï¸ Gruppe/Host '{{ selected_hosts }}' erkannt"
      when: run_validation

- name: "Proxmox Ansible Grundsetup (auf Zielhosts)"
  hosts: "{{ hostvars['localhost']['selected_hosts'] | default('proxyv3') }}"
  gather_facts: true
  become: true
  vars:
    backup_enabled: "{{ hostvars['localhost']['perform_backup'] }}"
    file_patterns: "{{ hostvars['localhost']['search_patterns'] }}"
    additional_paths: "{{ hostvars['localhost']['extra_paths'] }}"

  tasks:
    - name: "ğŸ¯ Setup-Informationen anzeigen"
      debug:
        msg:
          - "ğŸš€ Starte Setup auf: {{ inventory_hostname }}"
          - "ğŸ’¾ Backup aktiviert: {{ backup_enabled }}"
          - "ğŸ” Dateimuster: {{ file_patterns | join(', ') }}"

    - name: "ğŸ“¦ System Setup Tasks"
      debug:
        msg: "Hier wÃ¼rden die Rollen system_setup, user_management, project_backup laufen"
      # roles:
      #   - system_setup
      #   - user_management
      #   - project_backup

- name: "ğŸ“Š Post-Execution Validierung"
  hosts: controllers
  gather_facts: true  # <- erforderlich fÃ¼r ansible_date_time
  vars:
    validation_timestamp: "{{ ansible_date_time.iso8601 }}"

  tasks:
    - name: "ğŸ“ Log-Verzeichnis anlegen"
      file:
        path: "{{ playbook_dir }}/logs"
        state: directory
        mode: '0755'
      delegate_to: localhost

    - name: "ğŸ” Syntax-Check ausfÃ¼hren"
      shell: |
        ansible-playbook --syntax-check {{ playbook_dir }}/site.yml \
          -i {{ playbook_dir }}/inventory/hosts.yml
      register: final_syntax_check
      ignore_errors: true

    - name: "ğŸ§ª Dry-Run (Check-Modus)"
      shell: |
        ansible-playbook --check {{ playbook_dir }}/site.yml \
          -i {{ playbook_dir }}/inventory/hosts.yml \
          --limit {{ hostvars['localhost']['selected_hosts'] }}
      register: dry_run_test
      ignore_errors: true

    - name: "ğŸ“ Setup-Log schreiben"
      copy:
        content: |
          Timestamp: {{ validation_timestamp }}
          Hosts: {{ hostvars['localhost']['selected_hosts'] }}
          Syntax-Check: {{ 'OK' if final_syntax_check.rc == 0 else 'FEHLER' }}
          Dry-Run: {{ 'OK' if dry_run_test.rc == 0 else 'WARNUNGEN' }}
          Backup: {{ hostvars['localhost']['perform_backup'] }}
          Dateimuster: {{ hostvars['localhost']['search_patterns'] | join(', ') }}
          Extra Pfade: {{ hostvars['localhost']['extra_paths'] | join(', ') if hostvars['localhost']['extra_paths'] else 'Keine' }}
        dest: "{{ playbook_dir }}/logs/wizard_setup_{{ ansible_date_time.strftime('%Y%m%d_%H%M%S') }}.log"
      delegate_to: localhost

    - name: "ğŸ¯ Ampelstatus bestimmen"
      set_fact:
        status_msg: >-
          {% if final_syntax_check.rc == 0 and dry_run_test.rc == 0 %}
            ğŸŸ¢ Alles gut â€“ Setup erfolgreich!
          {% elif final_syntax_check.rc != 0 %}
            ğŸ”´ Syntax-Fehler entdeckt
          {% else %}
            ğŸŸ¡ Setup abgeschlossen mit Warnungen
          {% endif %}

    - name: "ğŸ“£ Zusammenfassung anzeigen"
      debug:
        msg:
          - "{{ status_msg }}"
          - "ğŸ•’ Zeitpunkt: {{ validation_timestamp }}"
          - "ğŸ¯ Hosts: {{ hostvars['localhost']['selected_hosts'] }}"
          - "ğŸš€ Backup: {{ hostvars['localhost']['perform_backup'] }}"
          - "ğŸ” Muster: {{ hostvars['localhost']['search_patterns'] | join(', ') }}"
          - "ğŸ“ Extra Pfade: {{ hostvars['localhost']['extra_paths'] | join(', ') if hostvars['localhost']['extra_paths'] else 'Keine' }}"
      when: hostvars['localhost']['run_validation'] | default(true)

