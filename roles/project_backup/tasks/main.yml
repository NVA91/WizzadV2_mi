---
- name: "ğŸ“‚ Backup-Zielverzeichnis auf dem Server prÃ¼fen"
  file:
    path: /srv/transfer/backup
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: "ğŸ“¦ Ansible-Projekt sichern (vom Controller zum Server)"
  # Wir nutzen 'synchronize' oder 'archive' lokal und kopieren es dann.
  # Einfacher fÃ¼r den Anfang: Wir packen das Playbook-Verzeichnis auf dem Zielhost,
  # FALLS es dort liegt (z.B. wenn du per git clone auf dem Server arbeitest).
  # Da wir aber remote arbeiten, sichern wir hier exemplarisch Konfigs.
  
  block:
    - name: "ğŸ’¾ Konfigurations-Backup erstellen"
      archive:
        path: 
          - /etc/pve/  # Proxmox Configs (nur wenn auf PVE Host)
        dest: "/srv/transfer/backup/pve_config_{{ ansible_date_time.date }}.tar.gz"
        format: gz
      ignore_errors: true # Ignorieren, falls wir noch nicht auf PVE sind
      register: pve_backup

    - name: "âœ… Backup Status"
      debug:
        msg: "Backup erstellt: {{ pve_backup.dest }}"
      when: pve_backup.changed
  rescue:
    - name: "âš ï¸ Backup fehlgeschlagen (aber Playbook lÃ¤uft weiter)"
      debug:
        msg: "Konnte Backup nicht erstellen. PrÃ¼fe Berechtigungen."
