---
# --- PHASE 0: Docker Basis ---
- name: "ğŸ—ï¸ BASE: Docker Engine & Network"
  include_tasks: docker_base.yml

- name: "ğŸŒ BASE: Netzwerk 'app_network'"
  docker_network:
    name: app_network
    state: present

# --- PHASE 1: Core Infrastructure (Ingress & Identity) ---
- name: "CORE: Infrastructure Stack"
  block:
    - name: "ğŸš¦ Traefik (Ingress)"
      include_tasks: core/traefik.yml
    
    - name: "ğŸ” Authentik (SSO/Identity)"
      include_tasks: core/authentik.yml
      
    - name: "ğŸ“œ Loki & Promtail (Logging)"
      include_tasks: core/logging.yml
      
    - name: "ğŸ“ˆ Monitoring (Prometheus/Grafana)"
      include_tasks: core/monitoring.yml
  when: hostvars['WIZARD_CONFIG']['do_infra'] | default(false)

# --- PHASE 2: Applications ---
- name: "APPS: Productivity & Media"
  block:
    - name: "ğŸ™ Portainer"
      include_tasks: apps/portainer.yml

    - name: "ğŸ“„ Paperless-ngx"
      include_tasks: apps/paperless_stack.yml
      
    - name: "â˜ï¸ Nextcloud"
      include_tasks: apps/nextcloud_stack.yml
      
    - name: "ğŸ¿ Jellyfin (AMD)"
      include_tasks: apps/jellyfin.yml
      
    - name: "ğŸ§  Whisper AI"
      include_tasks: apps/whisper.yml
      
    - name: "ğŸ Python Tools"
      include_tasks: apps/python_tools.yml
      
    - name: "ğŸ  Home Dashboard"
      include_tasks: apps/home_dashboard.yml
  when: hostvars['WIZARD_CONFIG']['do_apps'] | default(false)

# --- PHASE 3: Maintenance & Tests ---
- name: "TEST: Backup & Restore Validation"
  include_tasks: maintenance/backup_test.yml
  when: hostvars['WIZARD_CONFIG']['do_test'] | default(false)
