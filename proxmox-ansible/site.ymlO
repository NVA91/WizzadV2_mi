---
- name: Setup Wizard auf dem Controller ausfÃ¼hren
  hosts: localhost
  gather_facts: false
  vars_prompt:
    - name: "wizard_selected_hosts"
      prompt: "Welche Inventory-Gruppe oder Host(s) sollen durchsucht werden? (z.B. all, proxyv3)"
      private: no
      default: "proxyv3"
    - name: "wizard_perform_backup"
      prompt: "Backup der gefundenen Dateien auf Controller speichern? (true/false)"
      private: no
      default: "true"
    - name: "wizard_search_patterns"
      prompt: "Welche Dateimuster sollen durchsucht werden? (Komma-getrennt, z.B. *.conf,*.cfg,*.ini)"
      private: no
      default: "*.conf,*.cfg,*.ini"
    - name: "wizard_extra_paths"
      prompt: "ZusÃ¤tzliche Verzeichnisse durchsuchen? (Komma-getrennt, leer lassen fÃ¼r Standard)"
      private: no
      default: ""
  tasks:
    - name: Auswahl anzeigen
      debug:
        msg:
          - "Hosts: {{ wizard_selected_hosts }}"
          - "Backup: {{ wizard_perform_backup }}"
          - "Muster: {{ wizard_search_patterns }}"
          - "ZusÃ¤tzliche Pfade: {{ wizard_extra_paths }}"
    - name: Alle Variablen fÃ¼r weitere Rollen setzen
      set_fact:
        selected_hosts: "{{ wizard_selected_hosts }}"
        perform_backup: "{{ wizard_perform_backup | lower == 'true' }}"
        search_patterns: "{{ wizard_search_patterns.split(',') | map('trim') | list }}"
        extra_paths: >-
          {% if wizard_extra_paths | type_debug == 'str' and (wizard_extra_paths | trim | length > 0) %}
            {{ wizard_extra_paths.split(',') | map('trim') | list }}
          {% else %}
            []
          {% endif %}

- name: Proxmox Ansible Grundsetup (auf Zielhosts)
  hosts: "{{ selected_hosts | default('proxyv3') }}"
- name: Setup Wizard auf dem Controller ausfÃ¼hren
  hosts: localhost
  gather_facts: false
  vars_prompt:
    - name: "wizard_selected_hosts"
      prompt: "âœ… Welche Inventoryâ€‘Gruppe oder welche Hosts sollen durchsucht werden? (z.â€¯B. all, proxyv3)"
      private: no
      default: "proxyv3"
      confirm: yes

    - name: "wizard_perform_backup"
      prompt: "ğŸ’¾ Soll ein Backup der gefundenen Dateien auf dem Controller gespeichert werden? (ja/nein)"
      private: no
      default: "ja"
      confirm: yes

    - name: "wizard_search_patterns"
      prompt: "ğŸ” Welche Dateimuster sollen durchsucht werden? (Komma-getrennt, z.â€¯B. *.conf,*.cfg,*.ini)"
      private: no
      default: "*.conf,*.cfg,*.ini"
      confirm: yes

    - name: "wizard_extra_paths"
      prompt: "ğŸ“ ZusÃ¤tzliche Verzeichnisse durchsuchen? (komma-getrennt, leer = keine)"
      private: no
      default: ""
      confirm: yes

    - name: "wizard_run_validation"
      prompt: "âœ… Soll nach dem Setup eine vollstÃ¤ndige Validierung stattfinden? (ja/nein)"
      private: no
      default: "ja"
      confirm: yes

  tasks:
    # Deine bestehenden Tasks (Pre-flight, Setup-Block, Host-Check) unverÃ¤ndert hier einfÃ¼gen...

    # Erweiterte Validierung der Suchmuster
    - name: "ğŸ” Validierung der Suchmuster (*.ext)"
      assert:
        that:
          - wizard_search_patterns.split(',') | select('match','^\\*\\.[a-z0-9]+$') | list | length == (wizard_search_patterns.split(',') | list | length)
        fail_msg: "âŒ UngÃ¼ltiges Suchmuster: {{ wizard_search_patterns }} â€“ Muster mÃ¼ssen wie *.ext aussehen"
        success_msg: "âœ”ï¸ Suchmuster sind gÃ¼ltig"
      when: wizard_run_validation | lower == 'ja'

    # Beispiel-Erweiterung: Dateiendungen nur .csv oder .txt
    - name: "ğŸ” PrÃ¼fe Dateiendungen (.csv/.txt)"
      assert:
        that: item is match('.*\\.(csv|txt)$')
        fail_msg: "âŒ UngÃ¼ltige Dateiendung: {{ item }}"
        success_msg: "âœ”ï¸ OK: {{ item }}"
      loop: "{{ dateien }}"
      when: wizard_run_validation | lower == 'ja'
  become: true
  roles:
    - system_setup
    - user_management
    - project_backup

